<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ග්‍රහ බලය අනුව සුබ අක්ෂර සෙවීම - 2026</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Gemunu+Libre:wght@700&family=Noto+Serif+Sinhala:wght@400;600;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #FFA500; /* Orange */
            --secondary-color: #7F0000; /* Maroon */
            --bg-color: #fdfbf7;
            --card-bg: #ffffff;
            --text-color: #2c2c2c;
            --error-color: #d32f2f;
            --border-color: #d8bca8;
            --bg-cream: #FDF5E6;
            
            /* Status Colors */
            --status-green: #008000;
            --status-red: #d32f2f;
            --status-blue: #0000FF;
            --status-orange: #FFA500;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Noto Serif Sinhala', serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            align-items: center;
            padding: 15px;
        }

        .container {
            background-color: var(--card-bg);
            width: 100%;
            max-width: 600px;
            padding: 25px 20px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(127, 0, 0, 0.08);
            border-top: 5px solid var(--secondary-color);
            text-align: center;
        }

        h1 {
            font-family: 'Gemunu Libre', sans-serif;
            color: var(--secondary-color);
            font-size: 26px;
            margin-bottom: 25px;
            font-weight: 700;
            text-transform: uppercase;
            line-height: 1.2;
        }

        .form-group {
            margin-bottom: 15px;
            text-align: left;
        }

        label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--secondary-color);
            margin-bottom: 5px;
        }

        input[type="date"],
        input[type="time"],
        select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-family: 'Roboto', 'Noto Serif Sinhala', sans-serif;
            font-size: 15px;
            color: #333;
            background-color: #fffdfa;
            transition: all 0.3s ease;
        }

        input:focus, select:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(255, 165, 0, 0.2);
        }

        .cta-button {
            background-color: var(--secondary-color);
            color: #ffffff;
            font-family: 'Noto Serif Sinhala', sans-serif;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            padding: 12px 20px;
            width: 100%;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 15px;
            box-shadow: 0 4px 10px rgba(127, 0, 0, 0.25);
        }

        .cta-button:hover {
            background-color: #9c1414;
            transform: translateY(-2px);
        }
        
        .cta-button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .error-msg {
            color: var(--error-color);
            font-size: 13px;
            margin-top: 10px;
            display: none;
            font-weight: 600;
            background: #ffebee;
            padding: 8px;
            border-radius: 6px;
            text-align: left;
        }

        /* Chart Result Area */
        #result-area {
            margin-top: 30px;
            display: none;
            animation: slideUp 0.4s ease-out;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Astro Chart Styles --- */
        .chart-container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: 1fr 1fr 1fr;
            width: 100%;
            max-width: 400px;
            aspect-ratio: 1/1;
            margin: 20px auto;
            border: 3px solid var(--secondary-color);
            position: relative;
            background-color: #fffaf0;
        }

        .cell {
            border: 1px solid var(--border-color);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1em;
            font-weight: bold;
            text-align: center;
            line-height: 1.4;
            color: var(--text-color);
        }

        .center-cell {
            grid-column: 2 / 3;
            grid-row: 2 / 3;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px;
            background-color: var(--bg-cream);
        }

        .diagonal-line {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 0;
            pointer-events: none;
        }

        .top-content, .bottom-content {
            position: absolute;
            z-index: 1;
            padding: 2px;
            line-height: 1.1;
            width: 45%;
            text-align: center;
            font-size: 0.9em;
        }
        
        #preview-h2 { top: 7%; left: 45%; text-align: left; }
        #preview-h3 { bottom: 10%; right: 45%; text-align: right; }
        #preview-h12 { top: 7%; right: 45%; text-align: right; }
        #preview-h11 { bottom: 10%; left: 45%; text-align: left; }
        #preview-h5 { top: 7%; right: 45%; text-align: right; }
        #preview-h6 { bottom: 10%; left: 45%; text-align: left; }
        #preview-h9 { top: 7%; left: 45%; text-align: left; }
        #preview-h8 { bottom: 10%; right: 45%; text-align: right; }

        .zodiac-name {
            background-color: var(--secondary-color);
            color: white;
            padding: 4px 10px;
            border-radius: 5px;
            font-size: 1.2em;
            font-weight: bold;
            margin-top: 5px;
        }

        .lagna-img-center {
            width: 60px;
            height: auto;
            display: block;
        }

        /* --- Good/Bad Letters Styles --- */
        #good-bad-letters-area {
            margin: 25px 0;
            text-align: center;
        }

        .result-box {
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }

        .box-good {
            background-color: #e8f5e9;
            border: 2px solid var(--status-green);
        }

        .box-bad {
            background-color: #ffebee;
            border: 2px solid var(--status-red);
        }

        .box-title {
            font-family: 'Noto Serif Sinhala', serif;
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 10px;
            display: block;
        }
        
        .title-good { color: var(--status-green); }
        .title-bad { color: var(--status-red); }

        .letters-display {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            margin: 5px 0;
            line-height: 1.6;
        }

        /* --- Graha Balaya Styles --- */
        #graha-balaya-area {
            text-align: left;
            margin-top: 30px;
        }
        
        .balaya-card {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-left: 4px solid var(--secondary-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .balaya-header {
            font-family: 'Noto Serif Sinhala', serif;
            font-size: 1.2em;
            font-weight: bold;
            color: var(--secondary-color);
            margin-bottom: 10px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }

        .balaya-row {
            margin-bottom: 6px;
            font-size: 0.95em;
            line-height: 1.5;
            color: #000;
        }

        .letters-row {
            margin-top: 12px;
            font-weight: bold;
            color: #444;
            background: #f4f4f4;
            padding: 8px;
            border-radius: 5px;
            text-align: center;
        }

        /* Colors for Result Text Only */
        .text-green { color: var(--status-green); font-weight: 600; }
        .text-red { color: var(--status-red); font-weight: 600; }
        .text-blue { color: var(--status-blue); font-weight: 600; }
        .text-orange { color: var(--status-orange); font-weight: 600; }


        /* Summary Table */
        .summary-table {
            width: 100%;
            margin-top: 25px;
            border-collapse: collapse;
            font-size: 15px;
        }
        .summary-table th, .summary-table td {
            border: 1px solid var(--border-color);
            padding: 8px;
            text-align: left;
        }
        .summary-table th {
            background-color: var(--secondary-color);
            color: white;
            font-weight: normal;
        }
        .summary-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .footer {
            margin-top: auto;
            padding-top: 20px;
            padding-bottom: 3rem;
            font-size: 14px;
            color: #999;
            font-family: 'Roboto', sans-serif;
            text-align: center;
            width: 100%;
        }
        
        .main-wish {
            margin-top: 20px;
            font-size: 1.5em;
            color: var(--secondary-color);
            font-weight: bold;
        }

        /* Loader */
        #loading-indicator {
            display: none;
            margin: 20px 0;
            color: var(--primary-color);
            font-weight: bold;
        }

    </style>
</head>
<body>

    <div class="container">
        <h1>ග්‍රහ බලය අනුව සුබ අක්ෂර සෙවීම</h1>

        <div class="form-group">
            <label for="dateInput">උපන් දිනය තෝරන්න (2026)</label>
            <input type="date" id="dateInput" min="2026-01-01" max="2026-12-31">
        </div>

        <div class="form-group">
            <label for="timeInput">උපන් වේලාව තෝරන්න</label>
            <input type="time" id="timeInput">
        </div>

        <div class="form-group">
            <label for="districtSelect">උපන් දිස්ත්‍රික්කය තෝරන්න</label>
            <select id="districtSelect" onchange="populateCities()">
            </select>
        </div>

        <div class="form-group">
            <label for="citySelect">උපන් ස්ථානය තෝරන්න</label>
            <select id="citySelect">
                <option value="" disabled selected>දිස්ත්‍රික්කය තෝරන්න</option>
            </select>
        </div>

        <div class="form-group">
            <label for="genderInput">ස්ත්‍රී පුරුෂ භාවය</label>
            <select id="genderInput">
                <option value="" disabled selected>තෝරන්න</option>
                <option value="male">පුරුෂ</option>
                <option value="female">ස්ත්‍රී</option>
            </select>
        </div>

        <div id="errorDisplay" class="error-msg"></div>

        <button id="searchBtn" class="cta-button" onclick="calculateChart()">සොයන්න</button>
        <div id="loading-indicator">ගණනය කරමින් පවතී. රැඳී සිටින්න...</div>

        <div id="result-area">
            
            <div class="chart-container">
                <div class="cell">
                    <svg class="diagonal-line"><line x1="0" y1="0" x2="100%" y2="100%" stroke="var(--border-color)" stroke-width="1"/></svg>
                    <div class="top-content" id="preview-h2"></div>
                    <div class="bottom-content" id="preview-h3"></div>
                </div>
                <div class="cell" id="preview-h1"></div>
                <div class="cell">
                    <svg class="diagonal-line"><line x1="0" y1="100%" x2="100%" y2="0" stroke="var(--border-color)" stroke-width="1"/></svg>
                    <div class="top-content" id="preview-h12"></div>
                    <div class="bottom-content" id="preview-h11"></div>
                </div>
                
                <div class="cell" id="preview-h4"></div>
                <div class="center-cell">
                    <img id="center-lagna-img" class="lagna-img-center" src="" alt="Lagna">
                    <div class="zodiac-name" id="center-lagna-text">--</div>
                </div>
                <div class="cell" id="preview-h10"></div>

                <div class="cell">
                    <svg class="diagonal-line"><line x1="0" y1="100%" x2="100%" y2="0" stroke="var(--border-color)" stroke-width="1"/></svg>
                    <div class="top-content" id="preview-h5"></div>
                    <div class="bottom-content" id="preview-h6"></div>
                </div>
                <div class="cell" id="preview-h7"></div>
                <div class="cell">
                    <svg class="diagonal-line"><line x1="0" y1="0" x2="100%" y2="100%" stroke="var(--border-color)" stroke-width="1"/></svg>
                    <div class="top-content" id="preview-h9"></div>
                    <div class="bottom-content" id="preview-h8"></div>
                </div>
            </div>

            <div id="good-bad-letters-area"></div>

            <div id="graha-balaya-area"></div>

            <table class="summary-table">
                <thead>
                    <tr>
                        <th>ග්‍රහයා</th>
                        <th>හිමි රාශිය</th>
                    </tr>
                </thead>
                <tbody id="graha-table-body">
                </tbody>
            </table>

            <div class="main-wish">දීර්ඝායු වේවා !!!</div>
        </div>
    </div>

    <div class="footer">
        <p class="credits">© <span id="yearSpan"></span> Suba Namak | Astro Jayamaga. All Rights Reserved.</p>
    </div>

    <script>
        document.getElementById('yearSpan').textContent = new Date().getFullYear();

        // ==========================================
        //  CONFIGURATION: PASTE YOUR GAS WEB APP URL HERE
        //  NOTE: We added the ?tool parameter for routing
        // ==========================================
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyBQEAzmFPaRDnMi4Iuwr1hRAgxLg8Cp7mVEheAB81-6AlbvYNM7pTh1bkT32eUlfah/exec?tool=graha_balaya_2026"; 
        
        // ==========================================
        //  CLIENT SIDE LOCATION DATA
        // ==========================================
        const LOCATIONS = {
          "Colombo": [
            {name: "Colombo", lat: 6.9172436, lng: 79.8671954},
            {name: "Kollupitiya", lat: 6.88333, lng: 79.85000},
            {name: "Nugegoda", lat: 6.8649, lng: 79.8997},
            {name: "Maharagama", lat: 6.851095, lng: 79.921201},
            {name: "Homagama", lat: 6.8469074, lng: 79.9923651}
          ],
          "Kalutara": [
            {name: "Kalutara", lat: 6.5630625, lng: 79.9852435},
            {name: "Panadura", lat: 6.7217149, lng: 79.9067953},
            {name: "Horana", lat: 6.7112399, lng: 80.0669863}
          ],
          "Gampaha": [
            {name: "Gampaha", lat: 7.0532237, lng: 80.3289831},
            {name: "Negombo", lat: 7.2121161, lng: 79.849371},
            {name: "Kelaniya", lat: 6.950415, lng: 79.917142}
          ],
          "Galle": [
            {name: "Galle", lat: 6.036578, lng: 80.216479},
            {name: "Hikkaduwa", lat: 6.140753, lng: 80.1028181}
          ],
          "Matara": [
            {name: "Matara", lat: 5.9479065, lng: 80.5496589},
            {name: "Weligama", lat: 5.97503, lng: 80.418828}
          ],
          "Kandy": [
            {name: "Kandy", lat: 7.2865161, lng: 80.631418},
            {name: "Peradeniya", lat: 7.266409, lng: 80.5981261}
          ],
           "Kurunegala": [
            {name: "Kurunegala", lat: 7.4782607, lng: 80.36},
            {name: "Kuliyapitiya", lat: 7.484906, lng: 80.04}
          ],
           "Ratnapura": [
            {name: "Ratnapura", lat: 6.6871447, lng: 80.3924992},
            {name: "Embilipitiya", lat: 6.3261811, lng: 80.8419125}
          ],
           "Anuradhapura": [
            {name: "Anuradhapura", lat: 8.325781, lng: 80.40}
          ],
           "Jaffna": [
            {name: "Jaffna", lat: 9.6664323, lng: 80.0127075}
          ]
        };

        // 1. Initialize Page
        window.addEventListener('load', () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dateInput').value = today;
            
            const now = new Date();
            const timeStr = now.toTimeString().split(' ')[0].substring(0,5);
            document.getElementById('timeInput').value = timeStr;

            initLocations();
        });

        function initLocations() {
            // Populate District Dropdown immediately from local constant
            const distSelect = document.getElementById('districtSelect');
            distSelect.innerHTML = "";
            
            for (const dist in LOCATIONS) {
                const option = document.createElement('option');
                option.value = dist;
                option.text = dist; 
                distSelect.appendChild(option);
            }
            
            // Trigger City Population for first item (Default behavior)
            populateCities();
        }

        function populateCities() {
            const distSelect = document.getElementById('districtSelect');
            const citySelect = document.getElementById('citySelect');
            const selectedDist = distSelect.value;
            
            if(!LOCATIONS[selectedDist]) return;

            const cities = LOCATIONS[selectedDist];
            citySelect.innerHTML = "";
            
            cities.forEach(city => {
                const option = document.createElement('option');
                // Store lat/lng in value
                option.value = JSON.stringify({lat: city.lat, lng: city.lng});
                option.text = city.name;
                citySelect.appendChild(option);
            });
        }

        // 2. Main Calculation Logic
        async function calculateChart() {
            const dVal = document.getElementById('dateInput').value;
            const tVal = document.getElementById('timeInput').value;
            const genderVal = document.getElementById('genderInput').value;
            const cityJson = document.getElementById('citySelect').value;
            const errorDiv = document.getElementById('errorDisplay');
            const resultDiv = document.getElementById('result-area');
            const loadingInd = document.getElementById('loading-indicator');
            const searchBtn = document.getElementById('searchBtn');

            // Reset UI
            errorDiv.style.display = 'none';
            resultDiv.style.display = 'none';

            // Validation
            if(!dVal || !tVal || !genderVal || !cityJson) {
                errorDiv.innerText = "කරුණාකර සියලු තොරතුරු නිවැරදිව ඇතුලත් කරන්න.";
                errorDiv.style.display = 'block';
                return;
            }

            // Prepare Payload
            const cityObj = JSON.parse(cityJson);
            const payload = {
                action: "calculate",
                date: dVal,
                time: tVal,
                lat: cityObj.lat,
                lng: cityObj.lng,
                gender: genderVal 
            };

            // Loading State
            searchBtn.disabled = true;
            loadingInd.style.display = 'block';

            try {
                // Using POST for calculations
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                
                const data = await response.json();

                if(data.error) {
                    throw new Error(data.error);
                }

                renderResponse(data);
                resultDiv.style.display = 'block';

            } catch (error) {
                console.error("Calculation Error:", error);
                errorDiv.innerText = "ගණනය කිරීමේ දෝෂයක් සිදුවිය. කරුණාකර නැවත උත්සාහ කරන්න.";
                errorDiv.style.display = 'block';
            } finally {
                searchBtn.disabled = false;
                loadingInd.style.display = 'none';
            }
        }

        // 3. Render Results
        function renderResponse(data) {
            // A. Update Chart Center
            document.getElementById('center-lagna-text').innerText = data.lagna.name;
            document.getElementById('center-lagna-img').src = data.lagna.image;

            // B. Update Houses (1-12)
            for(let i=1; i<=12; i++) {
                const el = document.getElementById(`preview-h${i}`);
                if(data.houses[i] && data.houses[i].length > 0) {
                    el.innerText = data.houses[i].join(' ');
                } else {
                    el.innerText = i; // Show house number if empty
                }
            }

            // C. Summary Table
            const tbody = document.getElementById('graha-table-body');
            tbody.innerHTML = "";
            data.summaryTable.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${row.name}</td><td>${row.sign} රාශිය</td>`;
                tbody.appendChild(tr);
            });

            // D. Graha Balaya Cards
            const cardContainer = document.getElementById('graha-balaya-area');
            cardContainer.innerHTML = "";

            data.balayaDetails.forEach(p => {
                // Reconstruct HTML from data
                // Owned houses logic
                let ownedRowsHtml = "";
                p.ownedHtml.forEach(o => {
                    ownedRowsHtml += `<div class="balaya-row"><span class="${o.resClass}">${o.text}</span></div>`;
                });

                const card = document.createElement('div');
                card.className = "balaya-card";
                card.innerHTML = `
                    <div class="balaya-header">${p.planetName} ග්‍රහයාගේ බලය</div>
                    <div class="balaya-row">${p.planetName}ගේ රාශි බලය - <span class="${p.rashiHtml.css}">${p.rashiHtml.text} (${p.rashiHtml.sign}): ${p.rashiHtml.status}</span></div>
                    <div class="balaya-row">${p.planetName} සිටින භාවය - ${p.posHtml.name}: <span class="${p.posHtml.css}">${p.posHtml.text}</span></div>
                    ${ownedRowsHtml}
                    <div class="balaya-row">නෛසර්ගික ග්‍රහ බලපෑම - <span class="${p.naiHtml.css}">${p.naiHtml.text}: ${p.naiHtml.status}</span></div>
                    <div class="letters-row">හිමි අක්ෂර - ${p.letters}</div>
                `;
                cardContainer.appendChild(card);
            });

            // E. Good/Bad Letters
            const lettersContainer = document.getElementById('good-bad-letters-area');
            lettersContainer.innerHTML = "";

            if(data.goodLetters.length > 0) {
                const goodBox = document.createElement('div');
                goodBox.className = "result-box box-good";
                let lHtml = data.goodLetters.map(x => `<div>${x.letters}</div>`).join('');
                goodBox.innerHTML = `
                    <span class="box-title title-good">බලවත් ග්‍රහයින්ට අනුව සුබ අක්ෂර</span>
                    <div class="letters-display">${lHtml}</div>
                `;
                lettersContainer.appendChild(goodBox);
            }

            if(data.badLetters.length > 0) {
                const badBox = document.createElement('div');
                badBox.className = "result-box box-bad";
                let lHtml = data.badLetters.map(x => `<div>${x.letters}</div>`).join('');
                badBox.innerHTML = `
                    <span class="box-title title-bad">දුර්වල ග්‍රහයින්ට අනුව අසුබ අක්ෂර</span>
                    <div class="letters-display">${lHtml}</div>
                `;
                lettersContainer.appendChild(badBox);
            }
        }
    </script>
</body>
</html>
